using System;
using System.Collections.Generic;
using ImGuiNET;
using OpenTK.Windowing.Desktop;
using OpenTK.Mathematics;
using OpenTK.Windowing.GraphicsLibraryFramework;
using wraithspire.engine.objects.primitives;

namespace wraithspire.engine
{
    internal sealed class EditorUI
    {
        private bool _isPlaying;
        private bool _isPaused;
        public Camera Camera { get; } =new Camera();
        private Primitive? _selectedObject = null;

        public Action? OnCreateCube { get; set; }
        public List<Primitive> SceneObjects { get; set; } = new List<Primitive>();
        public Primitive? SelectedObject { get => _selectedObject; set => _selectedObject = value; }

        public Matrix4 CameraView => Camera.View;
        public Matrix4 CameraProjection => Camera.Projection;

        public (int X, int Y, int Width, int Height) ViewportRect { get; private set; }
        public void UpdateCamera(GameWindow window, int viewportWidth, int viewportHeight)
        {
            Camera.Update(window, viewportWidth, viewportHeight);
        }

        public void Render(GameWindow window)
        {
            float width = window.ClientSize.X;
            float height = window.ClientSize.Y;

            float topMargin = 0f;
            float leftWidth = MathF.Round(width * 0.20f);
            float rightWidth = MathF.Round(width * 0.25f);
            float bottomHeight = MathF.Round(height * 0.30f);
            float centerWidth = width - leftWidth - rightWidth;
            float centerHeight = height - bottomHeight - topMargin;

            // Toolbar
            ImGui.SetNextWindowPos(new System.Numerics.Vector2(leftWidth, topMargin), ImGuiCond.Always);
            ImGui.SetNextWindowSize(new System.Numerics.Vector2(centerWidth, 100f), ImGuiCond.Always);
            if (ImGui.Begin("Toolbar", ImGuiWindowFlags.None))
            {
                if (ImGui.Button(_isPlaying ? "Stop" : "Play"))
                {
                    _isPlaying = !_isPlaying;
                    if (!_isPlaying) _isPaused = false;
                }
                ImGui.SameLine();
                if (ImGui.Button(_isPaused ? "Resume" : "Pause"))
                {
                    if (_isPlaying)
                        _isPaused = !_isPaused;
                }
                ImGui.SameLine();
                ImGui.Text(_isPlaying ? (_isPaused ? "Paused" : "Playing") : "Stopped");
            }
            ImGui.End();

            // Viewport (dedicated window) - source of truth for the GL viewport rect.
            ImGui.SetNextWindowPos(new System.Numerics.Vector2(leftWidth, topMargin + 100f), ImGuiCond.Always);
            ImGui.SetNextWindowSize(new System.Numerics.Vector2(centerWidth, centerHeight - 100f), ImGuiCond.Always);
            var vpFlags = ImGuiWindowFlags.NoScrollbar | ImGuiWindowFlags.NoScrollWithMouse | ImGuiWindowFlags.NoCollapse;
            ImGui.PushStyleVar(ImGuiStyleVar.WindowPadding, new System.Numerics.Vector2(0, 0));
            ImGui.PushStyleVar(ImGuiStyleVar.WindowBorderSize, 1f);
            if (ImGui.Begin("Viewport", vpFlags))
            {
                var pos = ImGui.GetWindowPos();
                var size = ImGui.GetWindowSize();

                // Content region (excludes title bar) for accurate picking.
                var contentMin = ImGui.GetWindowContentRegionMin();
                var contentMax = ImGui.GetWindowContentRegionMax();

                int x = (int)MathF.Round(pos.X + contentMin.X);
                int y = (int)MathF.Round(pos.Y + contentMin.Y);
                int w = (int)MathF.Round(contentMax.X - contentMin.X);
                int h = (int)MathF.Round(contentMax.Y - contentMin.Y);
                if (w < 1) w = 1;
                if (h < 1) h = 1;
                ViewportRect = (x, y, w, h);
            }
            ImGui.End();
            ImGui.PopStyleVar(2);

            // Hierarchy
            ImGui.SetNextWindowPos(new System.Numerics.Vector2(0, topMargin), ImGuiCond.Always);
            ImGui.SetNextWindowSize(new System.Numerics.Vector2(leftWidth, centerHeight), ImGuiCond.Always);
            if (ImGui.Begin("Hierarchy", ImGuiWindowFlags.None))
            {
                ImGui.Text("Scene Hierarchy");
                ImGui.Separator();
                if (ImGui.TreeNodeEx("Root", ImGuiTreeNodeFlags.DefaultOpen))
                {
                    ImGui.PushID("Camera"); ImGui.BulletText("Camera"); ImGui.PopID();
                    ImGui.PushID("DirectionalLight"); ImGui.BulletText("Directional Light"); ImGui.PopID();
                    
                    // Display scene objects
                    for (int i = 0; i < SceneObjects.Count; i++)
                    {
                        var obj = SceneObjects[i];
                        ImGui.PushID(i);
                        bool isSelected = (_selectedObject == obj);
                        if (ImGui.Selectable(obj.Name, isSelected))
                        {
                            _selectedObject = obj;
                        }
                        ImGui.PopID();
                    }
                    
                    ImGui.TreePop();
                }

                // Right-click context menu
                if (ImGui.IsWindowHovered() && ImGui.IsMouseClicked(ImGuiMouseButton.Right))
                {
                    ImGui.OpenPopup("HierarchyContext");
                }

                if (ImGui.BeginPopup("HierarchyContext"))
                {
                    if (ImGui.BeginMenu("Objects"))
                    {
                        if (ImGui.MenuItem("Cube"))
                        {
                            OnCreateCube?.Invoke();
                        }
                        ImGui.EndMenu();
                    }
                    ImGui.EndPopup();
                }
            }
            ImGui.End();

            // Project
            ImGui.SetNextWindowPos(new System.Numerics.Vector2(0, topMargin + centerHeight), ImGuiCond.Always);
            ImGui.SetNextWindowSize(new System.Numerics.Vector2(width, bottomHeight), ImGuiCond.Always);
            if (ImGui.Begin("Project", ImGuiWindowFlags.None))
            {
                ImGui.Text("Project Files");
                ImGui.Separator();
                if (ImGui.BeginTable("ProjectTable", 2, ImGuiTableFlags.Borders | ImGuiTableFlags.RowBg))
                {
                    ImGui.TableSetupColumn("Assets");
                    ImGui.TableSetupColumn("Type");
                    ImGui.TableHeadersRow();

                    ImGui.TableNextRow();
                    ImGui.TableSetColumnIndex(0); ImGui.Text("scene.main");
                    ImGui.TableSetColumnIndex(1); ImGui.Text("Scene");

                    ImGui.TableNextRow();
                    ImGui.TableSetColumnIndex(0); ImGui.Text("textures/brick.png");
                    ImGui.TableSetColumnIndex(1); ImGui.Text("Texture");

                    ImGui.TableNextRow();
                    ImGui.TableSetColumnIndex(0); ImGui.Text("scripts/player.cs");
                    ImGui.TableSetColumnIndex(1); ImGui.Text("Script");

                    ImGui.EndTable();
                }
            }
            ImGui.End();

            // Inspector
            ImGui.SetNextWindowPos(new System.Numerics.Vector2(leftWidth + centerWidth, topMargin), ImGuiCond.Always);
            ImGui.SetNextWindowSize(new System.Numerics.Vector2(rightWidth, centerHeight), ImGuiCond.Always);
            if (ImGui.Begin("Inspector", ImGuiWindowFlags.None))
            {
                ImGui.Text("Inspector");
                ImGui.Separator();
                
                if (_selectedObject != null)
                {
                    ImGui.Text($"Selected: {_selectedObject.Name}");
                    
                    var pos = new System.Numerics.Vector3(_selectedObject.Position.X, _selectedObject.Position.Y, _selectedObject.Position.Z);
                    if (ImGui.DragFloat3("Position", ref pos, 0.1f))
                    {
                        _selectedObject.Position = new Vector3(pos.X, pos.Y, pos.Z);
                    }
                    
                    var rot = new System.Numerics.Vector3(_selectedObject.Rotation.X, _selectedObject.Rotation.Y, _selectedObject.Rotation.Z);
                    if (ImGui.DragFloat3("Rotation", ref rot, 1f))
                    {
                        _selectedObject.Rotation = new Vector3(rot.X, rot.Y, rot.Z);
                    }
                    
                    var scale = new System.Numerics.Vector3(_selectedObject.Scale.X, _selectedObject.Scale.Y, _selectedObject.Scale.Z);
                    if (ImGui.DragFloat3("Scale", ref scale, 0.01f))
                    {
                        _selectedObject.Scale = new Vector3(scale.X, scale.Y, scale.Z);
                    }
                }
                else
                {
                    ImGui.Text("No object selected");
                }
            }
            ImGui.End();
        }
    }
}
